# Fase 1: Normalización - Primera Forma Normal (1NF)

## Objetivo

Lograr **Primera Forma Normal (1NF)** separando valores no atómicos en tablas independientes. Transforma el diseño pre-normalizado de Fase 0 extrayendo "diseños" y "telas" en entidades propias, eliminando redundancia y estableciendo relaciones claras. Expande de 3 a 9 tablas, introduciendo el concepto de colecciones estacionales.

### Criterios de 1NF

Una tabla está en 1NF si:

1. ✅ **Todos los valores son atómicos** (no compuestos, no multivaluados)
2. ✅ **No hay grupos repetitivos** (cada columna contiene un solo valor)
3. ✅ **Cada registro es único** (tiene clave primaria)
4. ✅ **El orden de las filas no importa**

---

## Esquema de Base de Datos

**Nombre de Base de Datos**: `chamana_db_fase1`  
**Forma Normal**: 1NF (Primera Forma Normal)  
**Tablas**: 9 (expansión desde 3)

### Tablas Nuevas

#### 1. `disenos` - Diseños de Prendas

```sql
CREATE TABLE disenos (
    diseno_id SERIAL PRIMARY KEY,
    nombre VARCHAR(50) UNIQUE NOT NULL,  -- Ej: "Gaia", "Nube", "Tormenta"
    descripcion TEXT,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    activo BOOLEAN DEFAULT TRUE
);
```

**Propósito**: Separar concepto de "diseño" del nombre compuesto.

**Diseños Reales CHAMANA**:

- Gaia
- Nube
- Tormenta
- Rocio
- Brisa
- Aire
- Corteza
- Raiz

---

#### 2. `telas` - Tipos de Telas

```sql
CREATE TABLE telas (
    tela_id SERIAL PRIMARY KEY,
    nombre VARCHAR(100) UNIQUE NOT NULL,  -- Ej: "Jersey Bordó", "Plush Verde"
    tipo_tela VARCHAR(50),                -- Ej: "Jersey", "Plush", "Frisa"
    color VARCHAR(50),                    -- Ej: "Bordó", "Verde", "Negro"
    descripcion TEXT,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    activo BOOLEAN DEFAULT TRUE
);
```

**Propósito**: Eliminar redundancia de `tela_nombre` repetido.

**Tipos de Telas Reales**:

- Jersey (Bordó, Verde Musgo, Verde Agua)
- Plush (Verde, Naranja, Granate)
- Coral (Negro)
- Frisa (Verde, Negro)
- Algodon Rustico (Crudo)
- Modal (Natural, Hueso)
- Lycra (Gris, Verde)

---

#### 3. `años` - Años de Colección

```sql
CREATE TABLE años (
    año_id SERIAL PRIMARY KEY,
    numero INTEGER UNIQUE NOT NULL,  -- 2023, 2024, 2025
    activo BOOLEAN DEFAULT TRUE
);
```

**Propósito**: Organizar colecciones por año.

---

#### 4. `temporadas` - Temporadas del Año

```sql
CREATE TABLE temporadas (
    temporada_id SERIAL PRIMARY KEY,
    nombre VARCHAR(20) UNIQUE NOT NULL,  -- "Verano", "Invierno", "Otoño", "Primavera"
    descripcion TEXT,
    activo BOOLEAN DEFAULT TRUE
);
```

**Propósito**: Clasificar colecciones estacionales.

---

#### 5. `colecciones` - Colecciones Estacionales

```sql
CREATE TABLE colecciones (
    coleccion_id SERIAL PRIMARY KEY,
    nombre VARCHAR(100) UNIQUE NOT NULL,  -- "Verano 2024", "Invierno 2025"
    año_id INTEGER REFERENCES años(año_id),
    temporada_id INTEGER REFERENCES temporadas(temporada_id),
    fecha_inicio DATE,
    fecha_fin DATE,
    descripcion TEXT,
    activo BOOLEAN DEFAULT TRUE
);
```

**Propósito**: Agrupar prendas por colección estacional.

---

### Tablas Modificadas

#### 6. `prendas` (Actualizada para 1NF)

```sql
CREATE TABLE prendas (
    prenda_id SERIAL PRIMARY KEY,
    diseno_id INTEGER REFERENCES disenos(diseno_id),  -- ✅ FK reemplaza nombre_completo
    tela_id INTEGER REFERENCES telas(tela_id),        -- ✅ FK reemplaza tela_nombre
    categoria_id INTEGER REFERENCES categorias(categoria_id),
    coleccion_id INTEGER REFERENCES colecciones(coleccion_id),
    precio_chamana DECIMAL(10,2) NOT NULL,
    precio_arro DECIMAL(10,2),
    descuento_porcentaje DECIMAL(5,2),
    stock INTEGER DEFAULT 0,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    activo BOOLEAN DEFAULT TRUE,

    -- ✅ Constraint: Combinación única de diseño+tela
    UNIQUE(diseno_id, tela_id)
);
```

**Cambios Clave**:

- ❌ **Removido**: `nombre_completo` (valor compuesto)
- ❌ **Removido**: `tela_nombre` (redundante)
- ✅ **Añadido**: `diseno_id` (FK a tabla disenos)
- ✅ **Añadido**: `tela_id` (FK a tabla telas)
- ✅ **Añadido**: `coleccion_id` (FK a tabla colecciones)

---

#### 7. `clientes` (Sin cambios)

Permanece igual que Fase 0.

#### 8. `categorias` (Sin cambios)

Permanece igual que Fase 0.

---

## Cambios Clave desde Fase 0

### 1. Separación de Valores Compuestos

**Antes (Fase 0)**:

```sql
-- ❌ Valor compuesto en una columna
nombre_completo: "Gaia - Jersey Bordó"
```

**Después (Fase 1)**:

```sql
-- ✅ Valores atómicos en tablas separadas
disenos.nombre: "Gaia"
telas.nombre: "Jersey Bordó"

-- Relación en tabla prendas
diseno_id: 1 (FK → disenos)
tela_id: 5 (FK → telas)
```

---

### 2. Eliminación de Redundancia

**Antes (Fase 0)**:

```sql
-- ❌ "Jersey Bordó" repetido 5 veces
prenda_id | nombre_completo     | tela_nombre
----------+---------------------+-------------
1         | Gaia - Jersey Bordó | Jersey Bordó
2         | Nube - Jersey Bordó | Jersey Bordó
3         | ...                 | Jersey Bordó
```

**Después (Fase 1)**:

```sql
-- ✅ "Jersey Bordó" una sola vez en tabla telas
tela_id | nombre
--------+--------------
5       | Jersey Bordó

-- Prendas referencian con FK
prenda_id | diseno_id | tela_id
----------+-----------+--------
1         | 1 (Gaia)  | 5
2         | 2 (Nube)  | 5
```

---

### 3. Expansión de Tablas

| Métrica         | Fase 0 | Fase 1 | Cambio         |
| --------------- | ------ | ------ | -------------- |
| **Tablas**      | 3      | 9      | +6 (+200%)     |
| **Diseños**     | N/A    | 8      | Nuevo concepto |
| **Telas**       | N/A    | 25+    | Nuevo concepto |
| **Colecciones** | N/A    | 2      | Nuevo sistema  |

---

### 4. Sistema de Colecciones Estacionales

**Nueva Funcionalidad**:

- Organizar productos por temporada (Verano, Invierno)
- Agrupar por año (2024, 2025)
- Gestionar ciclos de colección (fecha_inicio, fecha_fin)

**Ejemplo**:

```
coleccion_id | nombre         | año  | temporada | activo
-------------+----------------+------+-----------+-------
1            | Verano 2024    | 2024 | Verano    | ✅
2            | Invierno 2025  | 2025 | Invierno  | ✅
```

---

## Resumen de Ejecución

### Proceso de Migración (7 Scripts)

1. **`00_db.js`**: Orquestador maestro
2. **`01_crear_database.js`**: Crea `chamana_db_fase1`
3. **`02_crear_tablas.js`**: Crea 9 tablas normalizadas
4. **`03_insertar_estaticos.js`**: Inserta años, temporadas, colecciones
5. **`04_migrar_clientes_categorias.js`**: Migra desde Fase 0
6. **`05_extraer_disenos_telas.js`**: Extrae diseños y telas de `nombre_completo`
7. **`06_migrar_prendas.js`**: Migra prendas con nuevas FKs
8. **`07_verificar.js`**: Verifica integridad y relaciones

### Resultados de Migración

**Datos Normalizados**:

- ✅ 8 diseños únicos extraídos
- ✅ 25+ telas únicas extraídas
- ✅ 31 prendas migradas con relaciones correctas
- ✅ 2 colecciones estacionales creadas
- ✅ 20 clientes migrados sin cambios
- ✅ 5 categorías migradas sin cambios

**Integridad Referencial**:

- ✅ Todas las FKs válidas
- ✅ No hay registros huérfanos
- ✅ Constraints UNIQUE funcionando

---

## Lecciones Aprendidas

### Éxitos

1. **Atomicidad Lograda**

   - Cada columna contiene un solo valor conceptual
   - Diseños y telas son entidades independientes

2. **Redundancia Eliminada**

   - Telas almacenadas una sola vez
   - Actualizaciones centralizadas (cambiar nombre de tela = un UPDATE)

3. **Flexibilidad Ganada**
   - Fácil agregar nuevos diseños sin afectar telas
   - Fácil agregar nuevas telas sin afectar diseños
   - Sistema de colecciones escalable

### Desafíos Encontrados

1. **Complejidad de Queries**

   - Ahora requieren JOINs múltiples para reconstruir "nombre completo"
   - Trade-off: Normalización vs Performance

2. **Migración de Datos**

   - Parsing de `nombre_completo` requiere lógica de string split
   - Mapeo manual de diseño-tela a nuevos IDs

3. **Nuevas Dependencias**
   - Más tablas = más puntos de falla potenciales
   - Necesidad de gestión cuidadosa de FKs

---

## Diagramas

- [Diagrama MER Fase 1](../blob/main/diagramas/fase1/01_MER_Fase1.md) - Modelo Conceptual
- [Diagrama DER Fase 1](../blob/main/diagramas/fase1/02_DER_Fase1.md) - Modelo Lógico
- [Comparación Fase 0 vs Fase 1](../blob/main/diagramas/comparaciones/01_Fase0_vs_Fase1.md)

---

## Ejemplos de Código

### Query: Obtener Producto con Diseño y Tela

```sql
-- ✅ Reconstruir "nombre completo" con JOINs
SELECT
    CONCAT(d.nombre, ' - ', t.nombre) AS nombre_completo,
    c.nombre AS categoria,
    col.nombre AS coleccion,
    p.precio_chamana,
    p.stock
FROM prendas p
JOIN disenos d ON p.diseno_id = d.diseno_id
JOIN telas t ON p.tela_id = t.tela_id
JOIN categorias c ON p.categoria_id = c.categoria_id
LEFT JOIN colecciones col ON p.coleccion_id = col.coleccion_id
WHERE p.activo = TRUE
ORDER BY c.nombre, d.nombre, t.nombre;
```

### Query: Buscar Productos por Tela (Eficiente)

```sql
-- ✅ MEJORA: Búsqueda directa por FK (no LIKE)
SELECT
    CONCAT(d.nombre, ' - ', t.nombre) AS producto,
    p.precio_chamana
FROM prendas p
JOIN disenos d ON p.diseno_id = d.diseno_id
JOIN telas t ON p.tela_id = t.tela_id
WHERE t.nombre = 'Jersey Bordó'  -- Búsqueda exacta, índice en FK
    AND p.activo = TRUE;
```

### Query: Listar Productos de Colección

```sql
SELECT
    col.nombre AS coleccion,
    c.nombre AS categoria,
    CONCAT(d.nombre, ' - ', t.nombre) AS producto,
    p.precio_chamana,
    p.stock
FROM prendas p
JOIN colecciones col ON p.coleccion_id = col.coleccion_id
JOIN categorias c ON p.categoria_id = c.categoria_id
JOIN disenos d ON p.diseno_id = d.diseno_id
JOIN telas t ON p.tela_id = t.tela_id
WHERE col.nombre = 'Verano 2024'
    AND p.activo = TRUE
ORDER BY c.nombre, p.precio_chamana DESC;
```

---

## Cómo Ejecutar Esta Fase

### Prerequisitos

- Fase 0 completada (para migración de datos)
- PostgreSQL 15+
- Node.js 18+

### Setup Completo

```bash
# 1. Navegar a scripts
cd 1.normalizacion/database/scripts

# 2. Instalar dependencias
npm install

# 3. Ejecutar script maestro (migra desde Fase 0)
node 00_db.js

# 4. Verificar migración
node 07_verificar.js
```

### Ejecutar Aplicación Web

```bash
cd ../../web
npm install
npm start
# http://localhost:3000
```

---

## Próxima Fase

**[Fase 2: Segunda Forma Normal (2NF)](2.3.Fase-2-Segunda-Forma-Normal)**

### Qué Viene

- ✅ Eliminar dependencias parciales
- ✅ Sistema completo de pedidos (`pedidos`, `pedidos_prendas`)
- ✅ Gestión automática de inventario (columnas generadas, triggers)
- ✅ Auditoría de movimientos de stock
- ✅ Junction table para disponibilidad estacional de telas

**Transformación**: 9 tablas (1NF) → 12 tablas (2NF) con sistema e-commerce completo

---

## Enlaces Relacionados

- [← Volver al Inicio del Wiki](Home)
- [← Fase Anterior: Fase 0 (Pre-normalizado)](2.1.Fase-0-Pre-Normalizado)
- [→ Siguiente: Fase 2 (2NF)](2.3.Fase-2-Segunda-Forma-Normal)
- [📊 Ver Diagramas de Esta Fase](../tree/main/diagramas/fase1)
- [🔄 Guía de Migración Fase 0 → Fase 1](3.2.Migration-Guides#fase-0-a-fase-1)

---

**Última Actualización**: 23 de Octubre, 2025  
**Estado**: ✅ Completa y funcional  
**Base de Datos**: `chamana_db_fase1`  
**Forma Normal**: 1NF (Primera Forma Normal)
